<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Fall 2022 Shopify Internship Challenge</title>
  </head>
  <body>
    <main x-data="inventory">
      <h1>Inventory Manager</h1>

      <div class="inventory-list">
        <h2>Inventory Items</h2>

        <label>
          <input
            type="checkbox"
            x-model="deleted"
            @change="resetDeleteForm && fetch"
          />
          Show Deleted Items
        </label>

        <table>
          <thead>
            <tr>
              <th>ID</th>
              <th>Name</th>
              <th>Stock</th>
              <th>City</th>
              <th>Weather</th>
              <th x-show="deleted">Deletion Reason</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <template x-for="item in items" :key="item.id">
              <tr>
                <td x-text="item.id"></td>
                <td x-text="item.name"></td>
                <td x-text="item.stock"></td>
                <td x-text="item.cityName"></td>
                <td x-text="item.cityWeather"></td>
                <td x-show="deleted" x-text="item.deletionComment"></td>
                <td>
                  <button
                    x-show="!deleted"
                    @click="(update.show = true) && (update.id = item.id) && (update.name = item.name) && (update.stock = item.stock) && (update.city = item.city) && (document.getElementById('after-table').scrollIntoView())"
                  >
                    Update
                  </button>
                  <button
                    x-show="!deleted"
                    @click="(showDeleteForm = true) && (deleteId = item.id) && (document.getElementById('after-table').scrollIntoView())"
                  >
                    Delete
                  </button>

                  <button x-show="deleted" @click="submitRestore(item.id)">
                    Restore
                  </button>
                </td>
              </tr>
            </template>
          </tbody>
        </table>
      </div>

      <div id="after-table"></div>

      <div id="delete-form" x-show="showDeleteForm">
        <p>
          Showing form to <strong>delete</strong> item with ID:
          <span x-text="deleteId"></span>
        </p>
        <form @submit.prevent="submitDelete(deleteId)">
          <p>
            <label>
              Deletion Reason:
              <input type="text" x-model="deletionComment" />
            </label>

            <span
              x-show="deleteValidationErrors.deletionComment"
              class="error"
              x-text="deleteValidationErrors.deletionComment"
            ></span>
          </p>

          <button type="submit">Delete</button>
          <button type="button" @click.submit="resetDeleteForm()">
            Cancel
          </button>
        </form>
      </div>

      <div id="update-form" x-show="update.show">
        <p>
          Showing form to <strong>update</strong> item with ID:
          <span x-text="update.id"></span>
        </p>

        <form @submit.prevent="submitUpdate()">
          <p>
            <label>
              Name:
              <input type="text" x-model="update.name" />
            </label>

            <span
              x-show="update.validationErrors.name"
              class="error"
              x-text="update.validationErrors.name"
            ></span>
          </p>

          <p>
            <label>
              Stock:
              <input type="number" x-model.number="update.stock" />
            </label>

            <span
              x-show="update.validationErrors.stock"
              class="error"
              x-text="update.validationErrors.stock"
            ></span>
          </p>

          <p>
            <label>
              City:
              <select x-model="update.city">
                <option value="OTTAWA">Ottawa</option>
                <option value="TORONTO">Toronto</option>
                <option value="VANCOUVER">Vancouver</option>
                <option value="NEW_YORK">New York</option>
                <option value="LONDON">London</option>
              </select>
            </label>

            <span
              x-show="update.validationErrors.city"
              class="error"
              x-text="update.validationErrors.city"
            ></span>
          </p>

          <button type="submit">Submit</button>
        </form>
      </div>

      <div class="create-form">
        <h2>Add Items</h2>

        <form @submit.prevent="submitCreate()">
          <p>
            <label>
              Name:
              <input type="text" x-model="create.name" />
            </label>

            <span
              x-show="create.validationErrors.name"
              class="error"
              x-text="create.validationErrors.name"
            ></span>
          </p>

          <p>
            <label>
              Stock:
              <input type="number" x-model.number="create.stock" />
            </label>

            <span
              x-show="create.validationErrors.stock"
              class="error"
              x-text="create.validationErrors.stock"
            ></span>
          </p>

          <p>
            <label>
              City:
              <select x-model="create.city">
                <option value="OTTAWA">Ottawa</option>
                <option value="TORONTO">Toronto</option>
                <option value="VANCOUVER">Vancouver</option>
                <option value="NEW_YORK">New York</option>
                <option value="LONDON">London</option>
              </select>
            </label>

            <span
              x-show="create.validationErrors.city"
              class="error"
              x-text="create.validationErrors.city"
            ></span>
          </p>

          <button type="submit">Submit</button>
          <button type="reset">Reset</button>
        </form>
      </div>
    </main>

    <script>
      function showError() {
        alert('Something went wrong please try again later')
      }

      document.addEventListener('alpine:init', () => {
        Alpine.data('inventory', () => ({
          async init() {
            await this.fetch(this.deleted)
          },

          // List
          items: [],
          deleted: false,
          async fetch() {
            const uri = this.deleted ? '/v1/inventory/deleted' : '/v1/inventory'

            try {
              const res = await fetch(uri)

              if (!res.ok) {
                console.error(
                  'Something went wrong fetching inventory items',
                  res
                )
                showError()
                return
              }

              const data = await res.json()
              console.log(data)
              this.items = data.inventories
            } catch (e) {
              console.error('Something went wrong fetching inventory items', e)
              showError()
            }
          },

          // Create Item Form
          create: {
            name: '',
            stock: 1,
            city: 'OTTAWA',
            validationErrors: {}
          },
          resetCreate() {
            this.name = ''
            this.stock = 1
            this.city = ''
            this.create.validationErrors = {}
          },
          async submitCreate() {
            try {
              console.log(this.create)
              const res = await fetch(`/v1/inventory`, {
                method: 'POST',
                body: JSON.stringify({
                  name: this.create.name,
                  stock:
                    this.create.stock === '' ? undefined : this.create.stock,
                  city: this.create.city
                }),
                headers: {
                  'Content-Type': 'application/json'
                }
              })

              const data = await res.json()

              if (res.status === 400) {
                this.create.validationErrors = data.validationErrors
              } else if (res.status === 201) {
                this.resetCreate()
                this.fetch(this.deleted)
              } else {
                showError()
              }
            } catch (e) {
              console.error('Something went wrong creating inventory item', e)
              showError()
            }
          },

          // Delete Item Form
          showDeleteForm: false,
          deleteId: '',
          deletionComment: '',
          deleteValidationErrors: {},
          resetDeleteForm() {
            this.showDeleteForm = false
            this.deleteId = ''
            this.deletionComment = ''
            this.deleteValidationErrors = {}
          },
          async submitDelete(id) {
            try {
              const res = await fetch(`/v1/inventory/${id}`, {
                method: 'DELETE',
                body: JSON.stringify({
                  deletionComment: this.deletionComment
                }),
                headers: {
                  'Content-Type': 'application/json'
                }
              })

              const data = await res.json()

              if (res.status === 400) {
                this.deleteValidationErrors = data.validationErrors
              } else if (res.status === 200) {
                this.fetch(this.deleted)
                this.resetDeleteForm()
              } else {
                showError()
              }
            } catch (e) {
              console.error('Something went wrong deleting inventory item', e)
              showError()
            }
          },

          // Restore Item
          async submitRestore(id) {
            try {
              const res = await fetch(`/v1/inventory/deleted/${id}`, {
                method: 'POST'
              })

              if (res.status === 201) {
                this.fetch(this.deleted)
                // this.resetDeleteForm()
              } else {
                showError()
              }
            } catch (e) {
              console.error('Something went wrong restoring inventory item', e)
              showError()
            }
          },

          // Update form
          update: {
            validationErrors: {},
            show: false,

            id: '',
            name: '',
            stock: 1,
            city: 'OTTAWA'
          },
          resetUpdateForm() {
            this.update.validationErrors = {}
            this.update.show = false

            this.update.id = ''
            this.update.name = ''
            this.update.stock = 1
            this.update.city = 'OTTAWA'
          },
          async submitUpdate() {
            try {
              const res = await fetch(`/v1/inventory/${this.update.id}`, {
                method: 'PATCH',
                body: JSON.stringify({
                  name: this.update.name,
                  stock:
                    this.update.stock === '' ? undefined : this.update.stock,
                  city: this.update.city
                }),
                headers: {
                  'Content-Type': 'application/json'
                }
              })

              const data = await res.json()

              if (res.status === 400) {
                this.update.validationErrors = data.validationErrors
              } else if (res.status === 200) {
                this.resetUpdateForm()
                this.fetch(this.deleted)
              } else {
                showError()
              }
            } catch (e) {
              console.error('Something went wrong updating inventory item', e)
              showError()
            }
          }
        }))
      })
    </script>

    <style>
      .error {
        color: red;
      }
    </style>

    <script src="//unpkg.com/alpinejs" defer></script>
    <link rel="stylesheet" href="//cdn.simplecss.org/simple.min.css" />
  </body>
</html>
